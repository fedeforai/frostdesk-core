sequenceDiagram
    participant WA as WhatsApp
    participant WH as webhook_whatsapp
    participant DB as Database
    participant ORC as orchestrateInboundDraft
    participant CLS as classifyRelevanceAndIntent
    participant DEC as decideBooking / escalationGate
    participant SUM as summaryPolicy / generateSummary
    participant DRF as runAiTask(draft_generation)
    participant GRD as sanitizeDraftText
    participant AUD as audit / telemetry

    WA->>WH: Inbound message (text)
    WH->>DB: Persist message (idempotent on external_message_id)
    WH->>DB: Upsert customer + conversation
    WH->>AUD: Audit: inbound_message_received

    WH->>ORC: orchestrateInboundDraft(messageId, conversationId, text, ...)
    Note over WH,ORC: try/catch — webhook returns 200 regardless

    ORC->>DB: Check ai_snapshot by messageId (idempotency)
    alt Snapshot exists
        ORC-->>WH: Return cached result
    end

    ORC->>CLS: classifyRelevanceAndIntent(text) [timeout: 2.5s]
    CLS-->>ORC: { relevance, intent, confidence }
    Note over CLS: Regex/keyword — no LLM

    ORC->>DEC: decideBooking({ relevance, intent })
    DEC-->>ORC: { action: ignore | escalate | ai_reply }

    alt action = ignore
        ORC->>DB: Insert ai_snapshot
        ORC->>AUD: Audit: ai_classification (ignore)
        ORC-->>WH: Return (no draft)
    end

    alt action = escalate
        ORC->>DB: Insert ai_snapshot
        ORC->>AUD: Audit: ai_classification (escalate)
        ORC-->>WH: Return (no draft)
    end

    Note over ORC: action = ai_reply — proceed to draft path

    ORC->>DB: Insert ai_snapshot
    ORC->>AUD: ai_usage_event (classification)

    ORC->>ORC: Check draft eligibility
    Note over ORC: gate.allowDraft AND operative intent AND confidence >= 0.6

    alt Draft not eligible
        ORC->>AUD: Audit: ai_draft_skipped (reason)
        ORC-->>WH: Return (no draft)
    end

    ORC->>ORC: Detect language (heuristic, sync)
    ORC->>DB: getLastCompletedBookingContext → customer context
    ORC->>DB: getConversationSummary → ai_summary

    ORC->>SUM: shouldUpdateSummary(messageCount, intentChanged, ...)
    alt Summary update needed
        ORC->>DB: getRecentMessagesForSummary
        ORC->>SUM: generateSummary(messages, existingSummary) [timeout: 3s]
        SUM-->>ORC: new summary or null
        ORC->>DB: updateConversationSummary
        ORC->>AUD: Audit: conversation_ai_summary_updated
    end

    ORC->>ORC: extractBookingFields(text, intent)

    alt intent = RESCHEDULE
        ORC->>ORC: extractRescheduleFields(text)
        ORC->>DB: findActiveBookingForReschedule(instructorId, customerId, date)
        alt Booking found + new times extracted
            ORC->>DB: validateAvailability(newStart, newEnd, excludeBookingId)
            alt Slot FREE
                Note over ORC: rescheduleVerified=true, context=[VERIFIED]
            else Slot CONFLICT
                Note over ORC: rescheduleVerified=false, context=[CONFLICT]
            end
        else No booking found
            Note over ORC: context=[NO BOOKING], ask clarification
        end
        ORC->>AUD: Audit: ai_reschedule_context_enriched
    end

    alt Structured booking draft (NEW_BOOKING/RESCHEDULE + fields complete)
        ORC->>DB: insertAIBookingDraft (status=pending_review)
        ORC->>AUD: Audit: ai_booking_draft_created
    else Generic text draft
        ORC->>DRF: runAiTask(draft_generation, text, context, language) [timeout: 6s]
        DRF-->>ORC: rawDraftText or timeout/error

        alt Timeout or error
            ORC->>AUD: Audit: ai_draft_timeout / ai_draft_skipped
            ORC-->>WH: Return (no draft)
        end

        ORC->>GRD: sanitizeDraftText(rawDraftText, rescheduleVerified)
        GRD-->>ORC: { safeDraftText, violations }
        Note over GRD: If rescheduleVerified=true, bypass commitment/date/time rules

        alt Blocked by guardrails
            ORC->>AUD: Audit: ai_draft_skipped (quality_blocked)
            ORC-->>WH: Return (no draft)
        end

        ORC->>DB: insertDraftOnce + upsertProposedDraft
        ORC->>AUD: Audit: ai_draft_generated
        ORC->>AUD: ai_usage_event (draft_generation)
    end

    ORC-->>WH: Return result
    WH-->>WA: HTTP 200
